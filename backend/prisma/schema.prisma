generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Consignment {
  id             String   @id
  customerNameRaw String?
  customerKey    String?
  destinationRaw String?
  destinationKey String?
  observationRaw String?
  mawbRaw        String?
  hawbRaw        String?
  packagesRaw    String?
  productDescriptionRaw String?
  etaIso         String?
  status         String?
  palletsFromSite Int?
  weightFromSite  Int?    // weight in kg from backoffice
  rawJson        String
  deliveryLocationId String?  // Optional override for delivery location
  lastSeenAt     DateTime
  archivedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  assignments    Assignment[]
  palletOverride PalletOverride?
  deliveryLocation DeliveryLocation? @relation(fields: [deliveryLocationId], references: [id], onDelete: SetNull)

  @@index([customerKey])
  @@index([destinationKey])
  @@index([status])
  @@index([lastSeenAt])
  @@index([deliveryLocationId])
}

model Lorry {
  id              String       @id @default(cuid())
  name            String
  truckClass      String       @default("Class1") // Class1 | Class2
  capacityPallets Int
  status          String       @default("on")
  driverId        String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  driver          Driver?      @relation(fields: [driverId], references: [id], onDelete: SetNull)
  assignments     Assignment[]
  trailers        Trailer[]
  scheduleEntries FleetSchedule[]

  @@index([name])
  @@index([driverId])
}

model Trailer {
  id        String   @id @default(cuid())
  number    String
  status    String   @default("spare") // on_road | off_road | storage | spare
  lorryId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lorry     Lorry?   @relation(fields: [lorryId], references: [id], onDelete: SetNull)
  scheduleEntries TrailerSchedule[]

  @@index([number])
  @@index([lorryId])
}

model TrailerSchedule {
  id        String   @id @default(cuid())
  trailerId String
  type      String   // "on_road" | "off_road" | "storage" | "spare"
  startAt   DateTime
  endAt     DateTime?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trailer   Trailer  @relation(fields: [trailerId], references: [id], onDelete: Cascade)

  @@index([trailerId])
  @@index([startAt])
}

model FleetSchedule {
  id        String    @id @default(cuid())
  lorryId   String
  type      String    // "off_road" | "service"
  startAt   DateTime
  endAt     DateTime?
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  lorry     Lorry     @relation(fields: [lorryId], references: [id], onDelete: Cascade)

  @@index([lorryId])
  @@index([startAt])
}

model Assignment {
  id            String     @id @default(cuid())
  lorryId       String
  consignmentId String
  sortOrder     Int
  isReload      Boolean    @default(false)  // Manual flag: this job is part of a reload/backload run

  lorry         Lorry      @relation(fields: [lorryId], references: [id], onDelete: Cascade)
  consignment   Consignment @relation(fields: [consignmentId], references: [id], onDelete: Cascade)

  @@unique([lorryId, consignmentId])
  @@index([lorryId])
  @@index([consignmentId])
}

model PalletOverride {
  consignmentId String @id
  pallets       Int

  consignment   Consignment @relation(fields: [consignmentId], references: [id], onDelete: Cascade)
}

model CustomerProfile {
  customerKey          String  @id
  displayName          String
  defaultPallets       Int
  emailTo              String?
  emailTemplateSubject String?
  emailTemplateBody    String?
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  passwordHash       String
  role               String   // Clerk | Planner | Management | Developer (SQLite has no enums)
  forcePasswordChange Boolean @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([email])
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?
  actorEmail String?
  actorRole  String?
  action     String
  entityType String
  entityId   String?
  message    String
  createdAt  DateTime @default(now())
  archivedAt DateTime?

  @@index([createdAt])
  @@index([archivedAt])
}

model CustomerPref {
  id           String   @id @default(cuid())
  displayName  String
  customerKey  String?  // optional link to CustomerProfile / consignments
  deliveryType String   // "deliver" | "self_collect"
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  locations    CustomerPrefDeliveryLocation[]

  @@index([deliveryType])
  @@index([customerKey])
}

model DeliveryLocation {
  id             String    @id @default(cuid())
  displayName    String
  destinationKey String?   // optional link to consignments
  address        String
  notes          String?
  postcode       String?
  lat            Float?
  lng            Float?
  geoUpdatedAt   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  prefs        CustomerPrefDeliveryLocation[]
  consignments Consignment[]

  @@index([destinationKey])
  @@index([postcode])
}

model CustomerPrefDeliveryLocation {
  customerPrefId     String
  deliveryLocationId String

  customerPref     CustomerPref     @relation(fields: [customerPrefId], references: [id], onDelete: Cascade)
  deliveryLocation DeliveryLocation @relation(fields: [deliveryLocationId], references: [id], onDelete: Cascade)

  @@id([customerPrefId, deliveryLocationId])
  @@index([deliveryLocationId])
}

model Driver {
  id          String   @id @default(cuid())
  name        String
  phoneNumber String?
  agency      String?
  idNumber    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lorries     Lorry[]

  @@index([name])
}

// Single row (id = "latest") for developer backoffice scrape log; persisted so all instances see it.
model ScrapeLogEntry {
  id                 String   @id @default("latest")
  timestamp          String
  totalRows          Int
  upserted           Int
  detectedPageParam  String?
  nextPageCount      Int
  skippedRows        Int
  sampleSkippedKeys  String   // JSON array
  errors             String   // JSON array
  updatedAt          DateTime @updatedAt
}
